import {
  GameMode,
  GameParticipantType,
  MediaType,
  QuestionRangeAnswerMargin,
  QuestionType,
} from '@quiz/common'
import { v4 as uuidv4 } from 'uuid'

import { GameDocument, GameStatus, TaskType } from '../models/schemas'

import { buildGameResultModel } from './game-result.converter'

describe('Game Result Converter', () => {
  describe('buildGameResultModel', () => {
    it('should create a game result model for a classic mode game', () => {
      const gameDocument: GameDocument = {
        _id: '816d14d6-9945-4f8a-afbd-dc7976f6d79d',
        created: new Date('2025-04-09T14:43:03.687Z'),
        currentTask: {
          _id: '8ddd37d7-c0a3-4a23-873b-cd331502ebdf',
          type: TaskType.Podium,
          status: 'completed',
          currentTransitionInitiated: new Date('2025-04-09T14:46:00.969Z'),
          created: new Date('2025-04-09T14:45:53.482Z'),
          leaderboard: [
            {
              playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
              position: 3,
              nickname: 'BraveStallion',
              score: 948,
              streaks: 0,
            },
            {
              playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
              position: 2,
              nickname: 'FieryBear',
              score: 2742,
              streaks: 2,
            },
            {
              playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
              position: 1,
              nickname: 'CosmicScorpion',
              score: 3891,
              streaks: 4,
            },
          ],
        },
        mode: GameMode.Classic,
        name: 'Classic Quiz Debug',
        nextQuestion: 4,
        participants: [
          {
            type: GameParticipantType.HOST,
            client: {
              _id: 'c976f0ae-219c-4687-bf3a-7ec91f534763',
              player: { _id: uuidv4() },
            },
            created: new Date('2025-04-09T14:43:03.687Z'),
            updated: new Date('2025-04-09T14:43:03.687Z'),
          },
          {
            type: GameParticipantType.PLAYER,
            client: {
              _id: 'd2f3dccc-0d29-474f-bacf-c92f664211af',
              player: { _id: 'c36386fd-34c9-4a93-b282-805c026fb62e' },
            },
            created: new Date('2025-04-09T14:43:15.956Z'),
            updated: new Date('2025-04-09T14:43:15.956Z'),
            totalScore: 3891,
            currentStreak: 4,
          },
          {
            type: GameParticipantType.PLAYER,
            client: {
              _id: '474dddd2-e793-40f0-84dc-e81bd0c9d34f',
              player: { _id: 'dc74af58-f7d3-4116-9194-019674a607dc' },
            },
            created: new Date('2025-04-09T14:43:25.876Z'),
            updated: new Date('2025-04-09T14:43:25.876Z'),
            totalScore: 2742,
            currentStreak: 2,
          },
          {
            type: GameParticipantType.PLAYER,
            client: {
              _id: '8259a14b-24a3-4437-bd2e-573960a83bc3',
              player: { _id: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1' },
            },
            created: new Date('2025-04-09T14:43:38.314Z'),
            updated: new Date('2025-04-09T14:43:38.314Z'),
            totalScore: 948,
            currentStreak: 0,
          },
        ],
        pin: '528610',
        previousTasks: [
          {
            _id: '3b9ae98c-2fe7-41b4-9a0e-e6b0d2661655',
            type: TaskType.Lobby,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:43:42.810Z'),
            currentTransitionExpires: new Date('2025-04-09T14:43:45.810Z'),
            created: new Date('2025-04-09T14:43:03.687Z'),
          },
          {
            _id: '73ef5481-ef82-4230-8301-2ed47446c65e',
            type: TaskType.Question,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:43:52.210Z'),
            created: new Date('2025-04-09T14:43:45.872Z'),
            questionIndex: 0,
            answers: [
              {
                type: QuestionType.MultiChoice,
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                created: new Date('2025-04-09T14:43:49.972Z'),
                answer: 0,
              },
              {
                type: QuestionType.MultiChoice,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                created: new Date('2025-04-09T14:43:51.231Z'),
                answer: 0,
              },
              {
                type: QuestionType.MultiChoice,
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                created: new Date('2025-04-09T14:43:52.137Z'),
                answer: 0,
              },
            ],
            presented: new Date('2025-04-09T14:43:49.028Z'),
          },
          {
            _id: 'b5601e48-89ab-4420-a887-5a9f4d00e9b7',
            type: TaskType.QuestionResult,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:43:55.594Z'),
            created: new Date('2025-04-09T14:43:52.225Z'),
            questionIndex: 0,
            results: [
              {
                type: QuestionType.MultiChoice,
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                answer: {
                  type: QuestionType.MultiChoice,
                  playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                  created: new Date('2025-04-09T14:43:49.972Z'),
                  answer: 0,
                },
                correct: true,
                lastScore: 984,
                totalScore: 984,
                position: 1,
                streak: 1,
              },
              {
                type: QuestionType.MultiChoice,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                answer: {
                  type: QuestionType.MultiChoice,
                  playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                  created: new Date('2025-04-09T14:43:51.231Z'),
                  answer: 0,
                },
                correct: true,
                lastScore: 963,
                totalScore: 963,
                position: 2,
                streak: 1,
              },
              {
                type: QuestionType.MultiChoice,
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                answer: {
                  type: QuestionType.MultiChoice,
                  playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                  created: new Date('2025-04-09T14:43:52.137Z'),
                  answer: 0,
                },
                correct: true,
                lastScore: 948,
                totalScore: 948,
                position: 3,
                streak: 1,
              },
            ],
          },
          {
            _id: '36c22085-af8f-4577-83fa-7427083ff882',
            type: TaskType.Leaderboard,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:44:05.520Z'),
            created: new Date('2025-04-09T14:43:55.605Z'),
            questionIndex: 0,
            leaderboard: [
              {
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                position: 1,
                nickname: 'CosmicScorpion',
                score: 984,
                streaks: 1,
              },
              {
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                position: 2,
                nickname: 'FieryBear',
                score: 963,
                streaks: 1,
              },
              {
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                position: 3,
                nickname: 'BraveStallion',
                score: 948,
                streaks: 1,
              },
            ],
          },
          {
            _id: '58b884bc-be8b-4ea4-bd9d-8216e159abe8',
            type: TaskType.Question,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:44:41.244Z'),
            created: new Date('2025-04-09T14:44:05.534Z'),
            questionIndex: 1,
            answers: [
              {
                type: QuestionType.Range,
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                created: new Date('2025-04-09T14:44:12.817Z'),
                answer: 50,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                created: new Date('2025-04-09T14:44:16.209Z'),
                answer: 0,
              },
            ],
            presented: new Date('2025-04-09T14:44:11.134Z'),
          },
          {
            _id: '7cec6fe7-de46-4d82-bb0b-9425392a3551',
            type: TaskType.QuestionResult,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:44:46.433Z'),
            created: new Date('2025-04-09T14:44:41.262Z'),
            questionIndex: 1,
            results: [
              {
                type: QuestionType.Range,
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                answer: {
                  type: QuestionType.Range,
                  playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                  created: new Date('2025-04-09T14:44:12.817Z'),
                  answer: 50,
                },
                correct: true,
                lastScore: 994,
                totalScore: 1978,
                position: 1,
                streak: 2,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                answer: {
                  type: QuestionType.Range,
                  playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                  created: new Date('2025-04-09T14:44:16.209Z'),
                  answer: 0,
                },
                correct: false,
                lastScore: 0,
                totalScore: 963,
                position: 2,
                streak: 0,
              },
              {
                type: QuestionType.Range,
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                correct: false,
                lastScore: 0,
                totalScore: 948,
                position: 3,
                streak: 0,
              },
            ],
          },
          {
            _id: '5cd0d9d2-33f9-4a4e-b724-9603c6616f16',
            type: TaskType.Leaderboard,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:44:55.672Z'),
            created: new Date('2025-04-09T14:44:46.447Z'),
            questionIndex: 1,
            leaderboard: [
              {
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                position: 1,
                nickname: 'CosmicScorpion',
                score: 1978,
                streaks: 2,
              },
              {
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                position: 2,
                nickname: 'FieryBear',
                score: 963,
                streaks: 0,
              },
              {
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                position: 3,
                nickname: 'BraveStallion',
                score: 948,
                streaks: 0,
              },
            ],
          },
          {
            _id: '3c35e563-24fd-40d0-ad99-b41a0049fffd',
            type: TaskType.Question,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:45:02.555Z'),
            created: new Date('2025-04-09T14:44:55.685Z'),
            questionIndex: 2,
            answers: [
              {
                type: QuestionType.TrueFalse,
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                created: new Date('2025-04-09T14:44:58.795Z'),
                answer: false,
              },
              {
                type: QuestionType.TrueFalse,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                created: new Date('2025-04-09T14:45:00.120Z'),
                answer: false,
              },
              {
                type: QuestionType.TrueFalse,
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                created: new Date('2025-04-09T14:45:02.489Z'),
                answer: true,
              },
            ],
            presented: new Date('2025-04-09T14:44:57.599Z'),
          },
          {
            _id: 'dea6cd6c-90ae-4084-910f-fb4dd453a16f',
            type: TaskType.QuestionResult,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:45:09.837Z'),
            created: new Date('2025-04-09T14:45:02.571Z'),
            questionIndex: 2,
            results: [
              {
                type: QuestionType.TrueFalse,
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                answer: {
                  type: QuestionType.TrueFalse,
                  playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                  created: new Date('2025-04-09T14:44:58.795Z'),
                  answer: false,
                },
                correct: true,
                lastScore: 980,
                totalScore: 2958,
                position: 1,
                streak: 3,
              },
              {
                type: QuestionType.TrueFalse,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                answer: {
                  type: QuestionType.TrueFalse,
                  playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                  created: new Date('2025-04-09T14:45:00.120Z'),
                  answer: false,
                },
                correct: true,
                lastScore: 958,
                totalScore: 1921,
                position: 2,
                streak: 1,
              },
              {
                type: QuestionType.TrueFalse,
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                answer: {
                  type: QuestionType.TrueFalse,
                  playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                  created: new Date('2025-04-09T14:45:02.489Z'),
                  answer: true,
                },
                correct: false,
                lastScore: 0,
                totalScore: 948,
                position: 3,
                streak: 0,
              },
            ],
          },
          {
            _id: 'f3489a9b-3e5e-452f-94aa-dca4b032eb91',
            type: TaskType.Leaderboard,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:45:13.392Z'),
            created: new Date('2025-04-09T14:45:09.850Z'),
            questionIndex: 2,
            leaderboard: [
              {
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                position: 1,
                nickname: 'CosmicScorpion',
                score: 2958,
                streaks: 3,
              },
              {
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                position: 2,
                nickname: 'FieryBear',
                score: 1921,
                streaks: 1,
              },
              {
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                position: 3,
                nickname: 'BraveStallion',
                score: 948,
                streaks: 0,
              },
            ],
          },
          {
            _id: '928c28c3-f6f6-4f1d-b1e1-2bd57d795a11',
            type: TaskType.Question,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:45:46.750Z'),
            created: new Date('2025-04-09T14:45:13.405Z'),
            questionIndex: 3,
            answers: [
              {
                type: QuestionType.TypeAnswer,
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                created: new Date('2025-04-09T14:45:20.697Z'),
                answer: 'copenhagen',
              },
              {
                type: QuestionType.TypeAnswer,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                created: new Date('2025-04-09T14:45:27.387Z'),
                answer: 'Köpenhamn',
              },
            ],
            presented: new Date('2025-04-09T14:45:16.676Z'),
          },
          {
            _id: '98df29b3-1b01-4c21-b830-c3835dc80a15',
            type: TaskType.QuestionResult,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-09T14:45:53.465Z'),
            created: new Date('2025-04-09T14:45:46.766Z'),
            questionIndex: 3,
            results: [
              {
                type: QuestionType.TypeAnswer,
                playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                answer: {
                  type: QuestionType.TypeAnswer,
                  playerId: 'c36386fd-34c9-4a93-b282-805c026fb62e',
                  created: new Date('2025-04-09T14:45:20.697Z'),
                  answer: 'copenhagen',
                },
                correct: true,
                lastScore: 933,
                totalScore: 3891,
                position: 1,
                streak: 4,
              },
              {
                type: QuestionType.TypeAnswer,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                answer: {
                  type: QuestionType.TypeAnswer,
                  playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                  created: new Date('2025-04-09T14:45:27.387Z'),
                  answer: 'Köpenhamn',
                },
                correct: true,
                lastScore: 821,
                totalScore: 2742,
                position: 2,
                streak: 2,
              },
              {
                type: QuestionType.TypeAnswer,
                playerId: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1',
                correct: false,
                lastScore: 0,
                totalScore: 948,
                position: 3,
                streak: 0,
              },
            ],
          },
        ],
        questions: [
          {
            type: QuestionType.MultiChoice,
            text: 'What is the capital of Sweden?',
            media: {
              type: MediaType.Image,
              url: 'https://d3hne3c382ip58.cloudfront.net/files/uploads/bookmundi/resized/cmsfeatured/stockholm-old-town-gamla-stan-1680860369-785X440.jpg',
            },
            points: 1000,
            duration: 30,
            options: [
              {
                value: 'Stockholm',
                correct: true,
              },
              {
                value: 'Paris',
                correct: false,
              },
              {
                value: 'London',
                correct: false,
              },
              {
                value: 'Berlin',
                correct: false,
              },
            ],
          },
          {
            type: QuestionType.Range,
            text: 'Guess the temperature of the hottest day ever recorded.',
            media: {
              type: MediaType.Image,
              url: 'https://nineplanets.org/wp-content/uploads/2019/09/Color-Temperature.jpg',
            },
            points: 1000,
            duration: 30,
            min: 0,
            max: 100,
            step: 2,
            margin: 'MEDIUM',
            correct: 50,
          },
          {
            type: QuestionType.TrueFalse,
            text: 'The earth is flat.',
            media: {
              type: MediaType.Image,
              url: 'https://cdn.sciencesensei.com/wp-content/uploads/2019/07/flat-earth-cover.jpg',
            },
            points: 1000,
            duration: 30,
            correct: false,
          },
          {
            type: QuestionType.TypeAnswer,
            text: 'What is the capital of Denmark?',
            media: {
              type: MediaType.Image,
              url: 'http://fayyaztravels.com/uploads/images/place/Copenhagen.jpg',
            },
            points: 1000,
            duration: 30,
            options: ['Copenhagen', 'Köpenhamn'],
          },
        ],
        quiz: { _id: 'b7955ac8-ccd1-4457-b6d0-36dd06de0ff2' },
        status: GameStatus.Active,
        updated: new Date('2025-04-09T14:46:00.984Z'),
      } as GameDocument

      const actual = buildGameResultModel(gameDocument)

      expect(actual).toEqual({
        _id: expect.anything(),
        name: gameDocument.name,
        game: gameDocument,
        host: { _id: expect.anything() },
        players: [
          {
            player: { _id: 'c36386fd-34c9-4a93-b282-805c026fb62e' },
            rank: 1,
            correct: 4,
            incorrect: 0,
            unanswered: 0,
            averageResponseTime: 1961,
            longestCorrectStreak: 4,
            score: 3891,
          },
          {
            player: { _id: 'dc74af58-f7d3-4116-9194-019674a607dc' },
            rank: 2,
            correct: 3,
            incorrect: 1,
            unanswered: 0,
            averageResponseTime: 5127,
            longestCorrectStreak: 2,
            score: 2742,
          },
          {
            player: { _id: '3bf8caf6-ca1b-44d2-bc8c-aaea03afb8b1' },
            rank: 3,
            correct: 1,
            incorrect: 1,
            unanswered: 2,
            averageResponseTime: 16999,
            longestCorrectStreak: 1,
            score: 948,
          },
        ],
        questions: [
          {
            text: 'What is the capital of Sweden?',
            type: QuestionType.MultiChoice,
            correct: 3,
            incorrect: 0,
            unanswered: 0,
            averageResponseTime: 2085,
          },
          {
            text: 'Guess the temperature of the hottest day ever recorded.',
            type: QuestionType.Range,
            correct: 1,
            incorrect: 1,
            unanswered: 1,
            averageResponseTime: 12252,
          },
          {
            text: 'The earth is flat.',
            type: QuestionType.TrueFalse,
            correct: 2,
            incorrect: 1,
            unanswered: 0,
            averageResponseTime: 2869,
          },
          {
            text: 'What is the capital of Denmark?',
            type: QuestionType.TypeAnswer,
            correct: 2,
            incorrect: 0,
            unanswered: 1,
            averageResponseTime: 14910,
          },
        ],
        hosted: new Date('2025-04-09T14:43:45.872Z'),
        completed: new Date('2025-04-09T14:45:53.482Z'),
      })
    })

    it('should create a game result model for a zero to one hundred mode game', () => {
      const gameDocument: GameDocument = {
        _id: '154b2fa4-6d7f-434f-b99a-c5bbc825fc1b',
        created: new Date('2025-04-11T15:21:00.069Z'),
        currentTask: {
          _id: '472292e0-4034-445f-9139-1b908c91922c',
          type: TaskType.Podium,
          status: 'completed',
          currentTransitionInitiated: new Date('2025-04-11T15:25:16.951Z'),
          created: new Date('2025-04-11T15:25:11.915Z'),
          leaderboard: [
            {
              playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
              position: 3,
              nickname: 'AtomicBasilisk',
              score: 236,
              streaks: 0,
            },
            {
              playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
              position: 2,
              nickname: 'FieryBear',
              score: 118,
              streaks: 0,
            },
            {
              playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
              position: 1,
              nickname: 'BraveBison',
              score: 70,
              streaks: 0,
            },
          ],
        },
        mode: GameMode.ZeroToOneHundred,
        name: '0-100 Quiz Debug',
        nextQuestion: 4,
        participants: [
          {
            type: GameParticipantType.HOST,
            client: {
              _id: 'c976f0ae-219c-4687-bf3a-7ec91f534763',
              player: { _id: uuidv4() },
            },
            created: new Date('2025-04-11T15:21:00.069Z'),
            updated: new Date('2025-04-11T15:21:00.069Z'),
          },
          {
            type: GameParticipantType.PLAYER,
            client: {
              _id: 'd3a3990b-261e-4c00-afb4-931b47331648',
              player: { _id: 'a145a38f-cb05-4ee5-b41a-6c4c16327321' },
            },
            created: new Date('2025-04-11T15:21:13.166Z'),
            updated: new Date('2025-04-11T15:21:13.166Z'),
            totalScore: 70,
            currentStreak: 0,
          },
          {
            type: GameParticipantType.PLAYER,
            client: {
              _id: '474dddd2-e793-40f0-84dc-e81bd0c9d34f',
              player: { _id: 'dc74af58-f7d3-4116-9194-019674a607dc' },
            },
            created: new Date('2025-04-11T15:21:22.480Z'),
            updated: new Date('2025-04-11T15:21:22.480Z'),
            totalScore: 118,
            currentStreak: 0,
          },
          {
            type: GameParticipantType.PLAYER,
            client: {
              _id: '163c67f4-1676-4096-9a82-8e6558606dae',
              player: { _id: '84aabd9d-e067-4930-b6d2-9048f295d190' },
            },
            created: new Date('2025-04-11T15:21:36.885Z'),
            updated: new Date('2025-04-11T15:21:36.885Z'),
            totalScore: 236,
            currentStreak: 0,
          },
        ],
        pin: '174282',
        previousTasks: [
          {
            _id: 'd9ae473b-f139-4b52-bc1b-d2ec03deeba8',
            type: TaskType.Lobby,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:21:43.117Z'),
            currentTransitionExpires: new Date('2025-04-11T15:21:46.117Z'),
            created: new Date('2025-04-11T15:21:00.069Z'),
          },
          {
            _id: '166f0a5d-8a40-4211-a952-05435924be71',
            type: TaskType.Question,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:22:55.399Z'),
            created: new Date('2025-04-11T15:21:46.184Z'),
            questionIndex: 0,
            answers: [
              {
                type: QuestionType.Range,
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                created: new Date('2025-04-11T15:21:57.556Z'),
                answer: 6,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                created: new Date('2025-04-11T15:22:02.519Z'),
                answer: 12,
              },
            ],
            presented: new Date('2025-04-11T15:21:55.266Z'),
          },
          {
            _id: '889e647e-4a32-4c90-9d1d-352f2d04467d',
            type: TaskType.QuestionResult,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:23:02.897Z'),
            created: new Date('2025-04-11T15:22:55.414Z'),
            questionIndex: 0,
            results: [
              {
                type: QuestionType.Range,
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                answer: {
                  type: QuestionType.Range,
                  playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                  created: new Date('2025-04-11T15:21:57.556Z'),
                  answer: 6,
                },
                correct: true,
                lastScore: -10,
                totalScore: -10,
                position: 1,
                streak: 1,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                answer: {
                  type: QuestionType.Range,
                  playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                  created: new Date('2025-04-11T15:22:02.519Z'),
                  answer: 12,
                },
                correct: false,
                lastScore: 6,
                totalScore: 6,
                position: 2,
                streak: 0,
              },
              {
                type: QuestionType.Range,
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                correct: false,
                lastScore: 100,
                totalScore: 100,
                position: 3,
                streak: 0,
              },
            ],
          },
          {
            _id: 'b450a146-5f61-438b-8b8a-810b7a003188',
            type: TaskType.Leaderboard,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:23:08.354Z'),
            created: new Date('2025-04-11T15:23:02.908Z'),
            questionIndex: 0,
            leaderboard: [
              {
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                position: 1,
                nickname: 'BraveBison',
                score: -10,
                streaks: 1,
              },
              {
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                position: 2,
                nickname: 'FieryBear',
                score: 6,
                streaks: 0,
              },
              {
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                position: 3,
                nickname: 'AtomicBasilisk',
                score: 100,
                streaks: 0,
              },
            ],
          },
          {
            _id: 'f7d9d8c0-d110-43a0-8f7c-f362f950fcfd',
            type: TaskType.Question,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:23:26.293Z'),
            created: new Date('2025-04-11T15:23:08.365Z'),
            questionIndex: 1,
            answers: [
              {
                type: QuestionType.Range,
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                created: new Date('2025-04-11T15:23:16.077Z'),
                answer: 90,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                created: new Date('2025-04-11T15:23:21.082Z'),
                answer: 80,
              },
              {
                type: QuestionType.Range,
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                created: new Date('2025-04-11T15:23:26.228Z'),
                answer: 60,
              },
            ],
            presented: new Date('2025-04-11T15:23:13.806Z'),
          },
          {
            _id: 'b84af6eb-8457-48f6-80be-5e56ea320860',
            type: TaskType.QuestionResult,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:23:34.479Z'),
            created: new Date('2025-04-11T15:23:26.308Z'),
            questionIndex: 1,
            results: [
              {
                type: QuestionType.Range,
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                answer: {
                  type: QuestionType.Range,
                  playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                  created: new Date('2025-04-11T15:23:16.077Z'),
                  answer: 90,
                },
                correct: true,
                lastScore: -10,
                totalScore: -20,
                position: 1,
                streak: 2,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                answer: {
                  type: QuestionType.Range,
                  playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                  created: new Date('2025-04-11T15:23:21.082Z'),
                  answer: 80,
                },
                correct: false,
                lastScore: 10,
                totalScore: 16,
                position: 2,
                streak: 0,
              },
              {
                type: QuestionType.Range,
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                answer: {
                  type: QuestionType.Range,
                  playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                  created: new Date('2025-04-11T15:23:26.228Z'),
                  answer: 60,
                },
                correct: false,
                lastScore: 30,
                totalScore: 130,
                position: 3,
                streak: 0,
              },
            ],
          },
          {
            _id: '3ca44484-bf44-4625-90d7-4678df6b40fc',
            type: TaskType.Leaderboard,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:23:40.800Z'),
            created: new Date('2025-04-11T15:23:34.491Z'),
            questionIndex: 1,
            leaderboard: [
              {
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                position: 1,
                nickname: 'BraveBison',
                score: -20,
                streaks: 2,
              },
              {
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                position: 2,
                nickname: 'FieryBear',
                score: 16,
                streaks: 0,
              },
              {
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                position: 3,
                nickname: 'AtomicBasilisk',
                score: 130,
                streaks: 0,
              },
            ],
          },
          {
            _id: 'ff5ba189-93ca-4ee3-8362-2ba4ea3a06ec',
            type: TaskType.Question,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:23:57.984Z'),
            created: new Date('2025-04-11T15:23:40.812Z'),
            questionIndex: 2,
            answers: [
              {
                type: QuestionType.Range,
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                created: new Date('2025-04-11T15:23:47.870Z'),
                answer: 14,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                created: new Date('2025-04-11T15:23:53.639Z'),
                answer: 12,
              },
              {
                type: QuestionType.Range,
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                created: new Date('2025-04-11T15:23:57.917Z'),
                answer: 20,
              },
            ],
            presented: new Date('2025-04-11T15:23:45.565Z'),
          },
          {
            _id: 'b472aaee-718d-4d71-9c3e-08678fb58424',
            type: TaskType.QuestionResult,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:24:00.963Z'),
            created: new Date('2025-04-11T15:23:58.007Z'),
            questionIndex: 2,
            results: [
              {
                type: QuestionType.Range,
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                answer: {
                  type: QuestionType.Range,
                  playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                  created: new Date('2025-04-11T15:23:47.870Z'),
                  answer: 14,
                },
                correct: true,
                lastScore: -10,
                totalScore: -30,
                position: 1,
                streak: 3,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                answer: {
                  type: QuestionType.Range,
                  playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                  created: new Date('2025-04-11T15:23:53.639Z'),
                  answer: 12,
                },
                correct: false,
                lastScore: 2,
                totalScore: 18,
                position: 2,
                streak: 0,
              },
              {
                type: QuestionType.Range,
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                answer: {
                  type: QuestionType.Range,
                  playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                  created: new Date('2025-04-11T15:23:57.917Z'),
                  answer: 20,
                },
                correct: false,
                lastScore: 6,
                totalScore: 136,
                position: 3,
                streak: 0,
              },
            ],
          },
          {
            _id: 'c18a2c0c-4813-40c3-82fe-5ff3fffe7f35',
            type: TaskType.Leaderboard,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:24:04.208Z'),
            created: new Date('2025-04-11T15:24:00.976Z'),
            questionIndex: 2,
            leaderboard: [
              {
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                position: 1,
                nickname: 'BraveBison',
                score: -30,
                streaks: 3,
              },
              {
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                position: 2,
                nickname: 'FieryBear',
                score: 18,
                streaks: 0,
              },
              {
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                position: 3,
                nickname: 'AtomicBasilisk',
                score: 136,
                streaks: 0,
              },
            ],
          },
          {
            _id: '5ec14c7d-c231-4345-98ea-144c2b83b461',
            type: TaskType.Question,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:25:08.938Z'),
            created: new Date('2025-04-11T15:24:04.221Z'),
            questionIndex: 3,
            answers: [],
            presented: new Date('2025-04-11T15:24:08.794Z'),
          },
          {
            _id: '30caf4a0-bd20-4493-8ebd-d86359aba30f',
            type: TaskType.QuestionResult,
            status: 'completed',
            currentTransitionInitiated: new Date('2025-04-11T15:25:11.901Z'),
            created: new Date('2025-04-11T15:25:08.957Z'),
            questionIndex: 3,
            results: [
              {
                type: QuestionType.Range,
                playerId: 'a145a38f-cb05-4ee5-b41a-6c4c16327321',
                correct: false,
                lastScore: 100,
                totalScore: 70,
                position: 1,
                streak: 0,
              },
              {
                type: QuestionType.Range,
                playerId: 'dc74af58-f7d3-4116-9194-019674a607dc',
                correct: false,
                lastScore: 100,
                totalScore: 118,
                position: 2,
                streak: 0,
              },
              {
                type: QuestionType.Range,
                playerId: '84aabd9d-e067-4930-b6d2-9048f295d190',
                correct: false,
                lastScore: 100,
                totalScore: 236,
                position: 3,
                streak: 0,
              },
            ],
          },
        ],
        questions: [
          {
            type: QuestionType.Range,
            text: '2002 levererades den första Koenigseggbilen av modell CC8S. Hur många tillverkades totalt?',
            media: {
              type: MediaType.Image,
              url: 'https://s1.cdn.autoevolution.com/images/gallery/KOENIGSEGG-CC8S-4049_7.jpg',
            },
            points: 0,
            duration: 60,
            min: 0,
            max: 100,
            step: 1,
            margin: QuestionRangeAnswerMargin.None,
            correct: 6,
          },
          {
            type: QuestionType.Range,
            text: 'Hur många år blev Kubas förre president Fidel Castro?',
            media: {
              type: MediaType.Image,
              url: 'http://www.turizmtatilseyahat.com/en/wp-content/uploads/2014/08/fidel-castro-kuba.jpg',
            },
            points: 0,
            duration: 60,
            min: 0,
            max: 100,
            step: 1,
            margin: QuestionRangeAnswerMargin.None,
            correct: 90,
          },
          {
            type: QuestionType.Range,
            text: 'Vilka är de två första decimalerna i talet pi?',
            media: {
              type: MediaType.Image,
              url: 'https://www.nationalgeographic.com.es/medio/2023/02/23/numero-pi_902def82_230223124056_1200x630.jpg',
            },
            points: 0,
            duration: 60,
            min: 0,
            max: 100,
            step: 1,
            margin: QuestionRangeAnswerMargin.None,
            correct: 14,
          },
          {
            type: QuestionType.Range,
            text: 'Hur många klädda kort finns det i en kortlek?',
            media: {
              type: MediaType.Image,
              url: 'https://hallmiba.com/thumb/2826/1024x0/d2b999d1709edbedeb911ad28ec8e6ab.jpg',
            },
            points: 0,
            duration: 60,
            min: 0,
            max: 100,
            step: 1,
            margin: QuestionRangeAnswerMargin.None,
            correct: 12,
          },
        ],
        quiz: { _id: '8a2923a1-80f4-4adb-aee1-0b82998186cb' },
        status: GameStatus.Active,
        updated: new Date('2025-04-11T15:25:16.966Z'),
      } as GameDocument

      const actual = buildGameResultModel(gameDocument)

      expect(actual).toEqual({
        _id: expect.anything(),
        name: gameDocument.name,
        game: gameDocument,
        host: { _id: expect.anything() },
        players: [
          {
            player: { _id: 'a145a38f-cb05-4ee5-b41a-6c4c16327321' },
            rank: 1,
            averagePrecision: 0.75,
            unanswered: 1,
            averageResponseTime: 16716,
            longestCorrectStreak: 3,
            score: 70,
          },
          {
            player: { _id: 'dc74af58-f7d3-4116-9194-019674a607dc' },
            rank: 2,
            averagePrecision: 0.7,
            unanswered: 1,
            averageResponseTime: 20650,
            longestCorrectStreak: 0,
            score: 118,
          },
          {
            player: { _id: '84aabd9d-e067-4930-b6d2-9048f295d190' },
            rank: 3,
            averagePrecision: 0.41,
            unanswered: 2,
            averageResponseTime: 36193,
            longestCorrectStreak: 0,
            score: 236,
          },
        ],
        questions: [
          {
            text: '2002 levererades den första Koenigseggbilen av modell CC8S. Hur många tillverkades totalt?',
            type: QuestionType.Range,
            averagePrecision: 0.65,
            unanswered: 1,
            averageResponseTime: 23181,
          },
          {
            text: 'Hur många år blev Kubas förre president Fidel Castro?',
            type: QuestionType.Range,
            averagePrecision: 0.87,
            unanswered: 0,
            averageResponseTime: 7323,
          },
          {
            text: 'Vilka är de två första decimalerna i talet pi?',
            type: QuestionType.Range,
            averagePrecision: 0.97,
            unanswered: 0,
            averageResponseTime: 7577,
          },
          {
            text: 'Hur många klädda kort finns det i en kortlek?',
            type: QuestionType.Range,
            averagePrecision: 0,
            unanswered: 3,
            averageResponseTime: 60000,
          },
        ],
        hosted: new Date('2025-04-11T15:21:46.184Z'),
        completed: new Date('2025-04-11T15:25:11.915Z'),
      })
    })
  })
})
