# .github/workflows/main.yml
name: Main
permissions: {}
on:
  push:
    branches:
      - main

jobs:
  build:
    permissions:
      contents: read
    uses: ./.github/workflows/build.yml
    secrets: inherit

  docker-build-and-push:
    needs: build
    permissions:
      contents: read
    uses: ./.github/workflows/docker-build-and-push.yml
    secrets: inherit

  deploy-beta:
    needs: docker-build-and-push
    uses: ./.github/workflows/deploy.yml
    with:
      target_env: beta
      tag: ${{ needs.docker-build-and-push.outputs.short_sha }}
    secrets:
      INFRA_REPO_PAT: ${{ secrets.INFRA_REPO_PAT }}
      QUIZ_PORTAINER_BETA_WEBHOOK: ${{ secrets.QUIZ_PORTAINER_BETA_WEBHOOK }}
      QUIZ_SERVICE_PORTAINER_BETA_WEBHOOK: ${{ secrets.QUIZ_SERVICE_PORTAINER_BETA_WEBHOOK }}

  sentry-release:
    needs: deploy-beta
    permissions:
      contents: read
    uses: ./.github/workflows/sentry-release.yml
    with:
      environment: beta
      release: ${{ github.sha }}
    secrets:
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
